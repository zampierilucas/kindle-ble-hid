name: Build ARM Hard-Float Binary (armhf)

on:
  push:
    branches: [main, refactor/pure-uhid-passthrough, feature/*]
    tags: ['v*']
  pull_request:
    branches: [main, refactor/pure-uhid-passthrough]
  workflow_dispatch:

jobs:
  build:
    # Use native ARM64 runner with Docker for ARM32 build
    # This is faster than x86 + QEMU because the ARM64 runner
    # can run ARM32 containers natively via kernel compat layer
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ARMv7 hard-float binary
        run: |
          docker buildx build \
            --platform linux/arm/v7 \
            --load \
            -t kindle-ble-hid-armhf-builder \
            -f - . <<'EOF'
          # ARMv7 hard-float (armhf) build
          FROM arm32v7/python:3.9-slim-bullseye

          # Install build dependencies
          RUN apt-get update && apt-get install -y --no-install-recommends \
              build-essential \
              patchelf \
              ccache \
              libffi-dev \
              && rm -rf /var/lib/apt/lists/*

          # Install Python build tools and dependencies
          RUN pip install --no-cache-dir \
              nuitka \
              ordered-set \
              zstandard \
              bumble>=0.0.193 \
              aiofiles>=23.0.0

          WORKDIR /build
          COPY bumble_ble_hid/*.py /build/
          COPY bumble_ble_hid/button_config.json /build/
          COPY bumble_ble_hid/requirements.txt /build/

          # Build with hard-float (default for armhf)
          RUN python3 -m nuitka \
              --mode=onefile \
              -j 4 \
              --lto=no \
              --output-filename=kindle-ble-hid-armhf \
              --include-data-file=button_config.json=button_config.json \
              --nofollow-import-to=pytest \
              --nofollow-import-to=unittest \
              --nofollow-import-to=setuptools \
              daemon.py
          EOF

      - name: Extract binary from container
        run: |
          docker create --name extract kindle-ble-hid-armhf-builder
          docker cp extract:/build/kindle-ble-hid-armhf ./kindle-ble-hid-armhf
          docker rm extract

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kindle-ble-hid-armhf
          path: kindle-ble-hid-armhf
          retention-days: 30

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: kindle-ble-hid-armhf
