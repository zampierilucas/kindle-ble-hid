name: Build ARM Soft-Float Binary (armel)

on:
  push:
    branches: [main, refactor/pure-uhid-passthrough, feature/*]
    tags: ['v*']
  pull_request:
    branches: [main, refactor/pure-uhid-passthrough]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Dockerfile for armel build
        run: |
          cat > Dockerfile.armel <<'DOCKERFILE'
          # ARMv7 soft-float (armel) build
          # Using balenalib armel image which provides proper soft-float support
          FROM balenalib/generic-armel-debian:bullseye-build

          # Install Python and build dependencies
          RUN apt-get update && apt-get install -y --no-install-recommends \
              python3 \
              python3-pip \
              python3-dev \
              build-essential \
              patchelf \
              ccache \
              libffi-dev \
              && rm -rf /var/lib/apt/lists/*

          # Install Python build tools and dependencies
          RUN pip3 install --no-cache-dir --break-system-packages \
              nuitka \
              ordered-set \
              zstandard \
              bumble>=0.0.193 \
              aiofiles>=23.0.0

          WORKDIR /build
          COPY bumble_ble_hid/*.py /build/
          COPY bumble_ble_hid/button_config.json /build/
          COPY bumble_ble_hid/requirements.txt /build/

          RUN python3 -m nuitka \
              --mode=onefile \
              -j 4 \
              --lto=no \
              --output-filename=kindle-ble-hid-armel \
              --include-data-file=button_config.json=button_config.json \
              --nofollow-import-to=pytest \
              --nofollow-import-to=unittest \
              --nofollow-import-to=setuptools \
              daemon.py
          DOCKERFILE

      - name: Build ARM soft-float binary
        run: |
          docker buildx build \
            --platform linux/arm/v5 \
            --load \
            -t kindle-ble-hid-armel-builder \
            -f Dockerfile.armel .

      - name: Extract binary from container
        run: |
          docker create --name extract kindle-ble-hid-armel-builder
          docker cp extract:/build/kindle-ble-hid-armel ./kindle-ble-hid-armel
          docker rm extract

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kindle-ble-hid-armel
          path: kindle-ble-hid-armel
          retention-days: 30

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: kindle-ble-hid-armel
