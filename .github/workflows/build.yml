name: Build Binaries

on:
  push:
    branches: [main, refactor/pure-uhid-passthrough, feature/*]
    tags: ['v*']
  pull_request:
    branches: [main, refactor/pure-uhid-passthrough]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: ${{ matrix.timeout }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: x86_64
            runner: ubuntu-22.04
            platform: linux/amd64
            image: python:3.9-slim-bullseye
            output: kindle-ble-hid-x86_64
            cflags: "-O1 -g0"
            nofollow_hci: ""
            timeout: 60
            pip_flags: "--break-system-packages"

          - name: armhf
            runner: ubuntu-24.04-arm
            platform: linux/arm/v7
            image: balenalib/raspberrypi3-debian:bookworm-build
            output: kindle-ble-hid-armhf
            cflags: "-Os -g0 -fomit-frame-pointer"
            nofollow_hci: ""
            timeout: 60
            pip_flags: "--break-system-packages"

          # NOTE: armel (soft-float) build is currently disabled due to:
          # 1. No pre-built wheels for arm32v5 (cryptography, etc.)
          # 2. Building from source requires Rust which fails under QEMU
          # 3. QEMU emulation is extremely slow (3+ hours)
          # For old Kindles that need armel, consider cross-compilation approach
          # - name: armel
          #   runner: ubuntu-22.04
          #   platform: linux/arm/v5
          #   image: arm32v5/debian:bullseye
          #   output: kindle-ble-hid-armel
          #   cflags: "-Os -g0 -fomit-frame-pointer"
          #   nofollow_hci: ""
          #   timeout: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Dockerfile
        run: |
          cat > Dockerfile.build <<EOFFILE
          FROM ${{ matrix.image }}

          # Install build dependencies
          RUN apt-get update && apt-get install -y --no-install-recommends \
              python3 \
              python3-pip \
              python3-dev \
              build-essential \
              patchelf \
              ccache \
              libffi-dev \
              && rm -rf /var/lib/apt/lists/*

          # Install Python build tools and dependencies
          RUN pip3 install --no-cache-dir ${{ matrix.pip_flags }} \
              nuitka \
              ordered-set \
              zstandard \
              bumble>=0.0.193 \
              aiofiles>=23.0.0

          WORKDIR /build
          COPY bumble_ble_hid/*.py /build/
          COPY bumble_ble_hid/devices/ /build/devices/
          COPY bumble_ble_hid/button_config.json /build/
          COPY bumble_ble_hid/requirements.txt /build/

          # Set C compilation flags per architecture
          ENV CFLAGS="${{ matrix.cflags }}"

          RUN python3 -m nuitka \
              --mode=onefile \
              --lto=no \
              --jobs=1 \
              --output-filename=${{ matrix.output }} \
              --include-data-file=button_config.json=button_config.json \
              --nofollow-import-to=pytest \
              --nofollow-import-to=unittest \
              --nofollow-import-to=setuptools \
              ${{ matrix.nofollow_hci }} \
              daemon.py
          EOFFILE

      - name: Build binary
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --load \
            -t kindle-ble-hid-builder \
            -f Dockerfile.build .

      - name: Extract binary from container
        run: |
          docker create --name extract kindle-ble-hid-builder
          docker cp extract:/build/${{ matrix.output }} ./${{ matrix.output }}
          docker rm extract

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: ${{ matrix.output }}
          retention-days: 30

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.output }}
