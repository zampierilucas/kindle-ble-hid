name: Build Binaries

on:
  push:
    branches: [main, refactor/pure-uhid-passthrough, feature/*]
    tags: ['v*']
  pull_request:
    branches: [main, refactor/pure-uhid-passthrough]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: x86_64
            runner: ubuntu-22.04
            platform: linux/amd64
            image: python:3.9-slim-bullseye
            output: kindle-ble-hid-x86_64

          - name: armhf
            runner: ubuntu-24.04-arm
            platform: linux/arm/v7
            image: arm32v7/python:3.9-slim-bullseye
            output: kindle-ble-hid-armhf

          - name: armel
            runner: ubuntu-24.04-arm
            platform: linux/arm/v6
            image: balenalib/rpi-debian:bookworm-build
            output: kindle-ble-hid-armel

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Dockerfile
        run: |
          cat > Dockerfile.build <<EOF
          FROM ${{ matrix.image }}

          # Install build dependencies
          RUN apt-get update && apt-get install -y --no-install-recommends \
              python3 \
              python3-pip \
              python3-dev \
              build-essential \
              patchelf \
              ccache \
              libffi-dev \
              && rm -rf /var/lib/apt/lists/*

          # Install Python build tools and dependencies
          RUN pip3 install --no-cache-dir --break-system-packages \
              nuitka \
              ordered-set \
              zstandard \
              bumble>=0.0.193 \
              aiofiles>=23.0.0 2>/dev/null || \
              pip3 install --no-cache-dir \
              nuitka \
              ordered-set \
              zstandard \
              bumble>=0.0.193 \
              aiofiles>=23.0.0

          WORKDIR /build
          COPY bumble_ble_hid/*.py /build/
          COPY bumble_ble_hid/button_config.json /build/
          COPY bumble_ble_hid/requirements.txt /build/

          # Set low memory C compilation flags
          ENV CFLAGS="-O1 -g0"

          RUN python3 -m nuitka \
              --mode=onefile \
              --lto=no \
              --jobs=1 \
              --output-filename=${{ matrix.output }} \
              --include-data-file=button_config.json=button_config.json \
              --nofollow-import-to=pytest \
              --nofollow-import-to=unittest \
              --nofollow-import-to=setuptools \
              daemon.py
          EOF

      - name: Build binary
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --load \
            -t kindle-ble-hid-builder \
            -f Dockerfile.build .

      - name: Extract binary from container
        run: |
          docker create --name extract kindle-ble-hid-builder
          docker cp extract:/build/${{ matrix.output }} ./${{ matrix.output }}
          docker rm extract

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: ${{ matrix.output }}
          retention-days: 30

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.output }}
